; platformio.ini
; Конфигурационный файл сборки для MeshStatic-Hybrid.
; PlatformIO читает этот файл и понимает, какие библиотеки, настройки и прошивки компилировать.

[platformio]
; Версия формата конфигурации (оставляем как есть)
core_version = 6.1.11
; Директория с исходным кодом прошивок
src_dir = firmware
; Окружение по умолчанию при сборке (если не указано другое)
default_envs = coordinator

; ==================== ОБЩИЕ НАСТРОЙКИ ДЛЯ ВСЕХ СРЕД ====================
[common]
; Флаги компилятора, применяемые ко всем прошивкам
build_flags =
    -Wno-error=maybe-uninitialized  ; Игнорировать некоторые предупреждения для ESP
    -Wno-unused-variable            ; Не считать ошибкой неиспользуемые переменные
    -D MESH_NETWORK_ID=0xFA23       ; Макрос! Передает в код сетевой ID (0xFA23)
    -D PROTOCOL_VERSION=0x01        ; Макрос! Передает версию протокола

; Общие библиотеки для всех устройств
lib_deps =
    bblanchon/ArduinoJson @ ^6.21.3 ; Библиотека для работы с JSON (для веб-интерфейса и конфигов)

; Настройки монитора порта (для отладки)
monitor_speed = 115200              ; Скорость обмена данными с COM-портом
monitor_filters = colorize          ; Раскрашивать вывод в терминале

; ==================== СРЕДА: КООРДИНАТОР (ESP32-S3) ====================
[env:coordinator]
; Основные настройки платформы
platform = espressif32              ; Платформа: чипы ESP32
board = esp32-s3-devkitc-1          ; Конкретная плата: ESP32-S3 DevKitC
framework = arduino                 ; Используем Arduino Framework для простоты
extends = common                    ; Наследуем все общие настройки из [common]

; Дополнительные флаги компиляции ТОЛЬКО для координатора
build_flags =
    ${common.build_flags}           ; Подключаем общие флаги
    -D DEVICE_TYPE=COORDINATOR      ; Макрос! Говорит коду, что это прошивка координатора
    -D ENABLE_WEB_SERVER=1          ; Макрос! Включает веб-сервер
    -D ENABLE_OTA=1                 ; Макрос! Включает обновление по воздуху (OTA)

; Дополнительные библиотеки, нужные ТОЛЬКО координатору
lib_deps =
    ${common.lib_deps}              ; Подключаем общие библиотеки (ArduinoJson)
    me-no-dev/ESPAsyncWebServer @ ^3.1.0 ; Асинхронный веб-сервер для интерфейса
    me-no-dev/AsyncTCP @ ^1.1.1     ; Основа для асинхронного веб-сервера

; Скорость загрузки прошивки в чип
upload_speed = 921600

; ==================== СРЕДА: РЕПИТЕР PRO (ESP32) ====================
[env:repeater_pro]
platform = espressif32
board = esp32dev                    ; Обычная плата ESP32 Dev Module
framework = arduino
extends = common                    ; Наследуем общие настройки

build_flags =
    ${common.build_flags}
    -D DEVICE_TYPE=REPEATER_PRO     ; Указываем тип устройства
    -D ENABLE_LOCAL_LOGIC=1         ; Включаем локальную обработку команд на репитере

lib_deps =
    ${common.lib_deps}              ; Только общие библиотеки

; ==================== СРЕДА: ДАТЧИК ТЕМПЕРАТУРЫ (ESP32-C3) ====================
[env:sensor_temperature]
platform = espressif32
board = esp32-c3-devkitm-1          ; Плата на энергоэффективном ESP32-C3
framework = arduino
extends = common

build_flags =
    ${common.build_flags}
    -D DEVICE_TYPE=SENSOR_TEMP      ; Указываем тип устройства
    -D DEEP_SLEEP_ENABLED=1         ; Включаем глубокий сон для экономии батареи
    -D SENSOR_UPDATE_INTERVAL=60000 ; Макрос! Интервал отправки данных (60 сек)

lib_deps =
    ${common.lib_deps}
    adafruit/Adafruit Unified Sensor @ ^1.1.6 ; Драйверы датчиков
    adafruit/Adafruit BME280 Library @ ^2.2.2 ; Конкретная библиотека для BME280

; ==================== СЦЕНАРИИ СБОРКИ (СКРИПТЫ) ====================
; Эти скрипты можно запускать из командной строки PlatformIO.
[scripts]
; Собрать все прошивки разом
build_all = pio run
; Собрать и загрузить прошивку для координатора
flash_coordinator = pio run -e coordinator -t upload
; Собрать и загрузить прошивку для репитера
flash_repeater = pio run -e repeater_pro -t upload
; Очистить все сборочные файлы
clean_all = pio run -t clean
