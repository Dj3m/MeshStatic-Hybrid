# Логика работы MeshStatic-Hybrid системы

## 🎯 Основная философия

### 1. Автономность как приоритет
Система проектируется для работы БЕЗ:
- Интернета
- Облачных сервисов  
- Внешних серверов
- Централизованных контроллеров

### 2. Распределённый интеллект
Логика делится на 3 уровня:
- **Уровень 1:** Рефлексы (репитер → устройства) - 10-50 мс
- **Уровень 2:** Координация (координатор) - 100-500 мс  
- **Уровень 3:** Стратегия (человек/правила) - секунды/минуты

### 3. Graceful Degradation
При отказе компонентов система:
1. Сохраняет критичные функции
2. Упрощает не критичные
3. Сообщает о проблемах
4. Восстанавливается автоматически

## 🔄 Рабочие циклы

### Цикл координатора (100 мс)


┌─────────────────────────────────────┐
│ 1. Проверка входящих ESP-NOW пакетов│
│ 2. Обновление таблицы маршрутизации │
│ 3. Обработка локальных событий      │
│ 4. Отправка heartbeat               │
│ 5. Проверка веб-запросов            │
└─────────────────────────────────────┘

```

### Цикл репитера (50 мс)
```

┌─────────────────────────────────────┐
│ 1. Приём пакетов от детей/родителя  │
│ 2. Проверка флага local_process     │
│ 3. Локальная обработка групповых    │
│    команд (если флаг установлен)    │
│ 4. Маршрутизация остальных пакетов  │
│ 5. Отправка статуса родителю        │
└─────────────────────────────────────┘

```

### Цикл датчика (спящий)
```

┌─────────────────────────────────────┐
│ 1. Глубокий сон (10-100 мкА)        │
│ 2. Пробуждение по:                  │
│    - Таймеру (каждые 60 сек)        │
│    - Прерыванию (PIR, геркон)       │
│ 3. Сбор данных с датчиков           │
│ 4. Отправка пакета родителю         │
│ 5. Немедленный возврат в сон        │
└─────────────────────────────────────┘

```

## 📡 Протокол связи

### Принцип "Не доверяй, проверяй"
Каждый пакет проверяется:
1. **Network ID** - принадлежность к нашей сети
2. **TTL** - не устарел ли маршрут
3. **CRC32** - целостность данных
4. **MAC белый список** - известные устройства
5. **Шифрование** (опционально) - конфиденциальность

### Типы пакетов по приоритету

#### Высший приоритет (обрабатываются немедленно)
- `EVENT_BROADCAST` - аварийные события (пожар, протечка)
- `HEARTBEAT` - пульс устройств
- `CMD_GROUP` с флагом `local_process` - локальные команды

#### Средний приоритет (очередь 100 мс)
- `CMD_SET` - команды управления
- `ROUTING_UPDATE` - обновление маршрутов

#### Низкий приоритет (очередь 1 сек)
- `DATA_SENSOR` - телеметрия
- `DISCOVERY` - поиск устройств

## 🏗️ Архитектура принятия решений

### Правила выполнения команд

```

IF получена_команда THEN
IF команда.флаги.local_process = true THEN
// Локальная обработка на репитере
найти_устройства_в_группе(команда.group_id)
